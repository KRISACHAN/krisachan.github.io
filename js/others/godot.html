<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>像监听页面一样监听戈多的动态 | 鱼头的Web海洋</title>
    <meta name="description" content="让你的Web学习如同玩耍在海洋一样快乐" />
    <link rel="icon" href="https://fish-pond-1253945200.cos.ap-guangzhou.myqcloud.com/base/blogfavicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.a57752fc.css" as="style"><link rel="preload" href="/assets/js/app.64027d33.js" as="script"><link rel="preload" href="/assets/js/37.6b8a54ca.js" as="script"><link rel="prefetch" href="/assets/js/2.ee28eecc.js"><link rel="prefetch" href="/assets/js/3.4f75b704.js"><link rel="prefetch" href="/assets/js/4.bf787673.js"><link rel="prefetch" href="/assets/js/5.478f5ac2.js"><link rel="prefetch" href="/assets/js/6.4c097f64.js"><link rel="prefetch" href="/assets/js/7.58a8b71c.js"><link rel="prefetch" href="/assets/js/8.3f46aa1d.js"><link rel="prefetch" href="/assets/js/9.b22bdfb2.js"><link rel="prefetch" href="/assets/js/10.66b6a51e.js"><link rel="prefetch" href="/assets/js/11.7e6ee11d.js"><link rel="prefetch" href="/assets/js/12.00a57e71.js"><link rel="prefetch" href="/assets/js/13.a3ebb5cb.js"><link rel="prefetch" href="/assets/js/14.24257f57.js"><link rel="prefetch" href="/assets/js/15.e9fbe090.js"><link rel="prefetch" href="/assets/js/16.3274933f.js"><link rel="prefetch" href="/assets/js/17.c44a15a9.js"><link rel="prefetch" href="/assets/js/18.9d746e2b.js"><link rel="prefetch" href="/assets/js/19.baae15bc.js"><link rel="prefetch" href="/assets/js/20.9aaca5ee.js"><link rel="prefetch" href="/assets/js/21.aec3f975.js"><link rel="prefetch" href="/assets/js/22.cba23bf4.js"><link rel="prefetch" href="/assets/js/23.4dd14c76.js"><link rel="prefetch" href="/assets/js/24.7aeb3519.js"><link rel="prefetch" href="/assets/js/25.1defca15.js"><link rel="prefetch" href="/assets/js/26.95a5affe.js"><link rel="prefetch" href="/assets/js/27.658e569c.js"><link rel="prefetch" href="/assets/js/28.cf9f578c.js"><link rel="prefetch" href="/assets/js/29.c241490c.js"><link rel="prefetch" href="/assets/js/30.575fb260.js"><link rel="prefetch" href="/assets/js/31.5909ea61.js"><link rel="prefetch" href="/assets/js/32.fbc6772e.js"><link rel="prefetch" href="/assets/js/33.c3a0c9bf.js"><link rel="prefetch" href="/assets/js/34.2dc66dcd.js"><link rel="prefetch" href="/assets/js/35.a07824d8.js"><link rel="prefetch" href="/assets/js/36.259e126a.js"><link rel="prefetch" href="/assets/js/38.cefea094.js"><link rel="prefetch" href="/assets/js/39.c960ca00.js"><link rel="prefetch" href="/assets/js/40.7b2ead41.js"><link rel="prefetch" href="/assets/js/41.4ac953b2.js"><link rel="prefetch" href="/assets/js/42.9a84c1d2.js"><link rel="prefetch" href="/assets/js/43.17d7ba6b.js"><link rel="prefetch" href="/assets/js/44.6697b9a5.js"><link rel="prefetch" href="/assets/js/45.f13da887.js"><link rel="prefetch" href="/assets/js/46.03a48d34.js"><link rel="prefetch" href="/assets/js/47.099c525e.js"><link rel="prefetch" href="/assets/js/48.5dfb158d.js"><link rel="prefetch" href="/assets/js/49.fffb4f6a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a57752fc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">鱼头的Web海洋</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!----> <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>像监听页面一样监听戈多的动态</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/js/others/godot.html#object-defineproperty" class="sidebar-link">Object.defineProperty</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/js/others/godot.html#mutationobserver" class="sidebar-link">MutationObserver</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/js/others/godot.html#intersection-observer" class="sidebar-link">Intersection Observer</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/js/others/godot.html#后记" class="sidebar-link">后记</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="像监听页面一样监听戈多的动态"><a href="#像监听页面一样监听戈多的动态" aria-hidden="true" class="header-anchor">#</a> 像监听页面一样监听戈多的动态</h1> <blockquote><ul><li>作者：陈大鱼头</li> <li>github： <a href="https://github.com/KRISACHAN" target="_blank" rel="noopener noreferrer">KRISACHAN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></blockquote> <p>不知道各位童鞋有木有看过 <strong>《等待戈多》</strong> 这部出名的荒诞戏剧 。其剧情大概就是 戈戈 与 狄狄 等待 戈多 的过程中发生的一些琐事，一共两幕。等了这么多年，也不知道 戈多 现在在哪，赴约了没有。</p> <p>如果 戈戈 与 狄狄 像我们监听页面元素变化那样监听戈多的动态，是不是就不会出现空欢喜的状态？是不是就不用等得那么辛苦？是不是甚至可以主动去寻找戈多？</p> <p><img src="https://fish-pond-1253945200.cos.ap-guangzhou.myqcloud.com/js/godot/wait.jpg" alt="wait"></p> <p>说起监听页面元素变化，那么你可知道有哪些方法可以实现这个功能？</p> <h2 id="object-defineproperty"><a href="#object-defineproperty" aria-hidden="true" class="header-anchor">#</a> Object.defineProperty</h2> <p>关于 <strong><code>Object.defineProperty</code></strong> 这个属性大家应该很熟（毕竟是各类面经中的常客），但还是要简单介绍下~</p> <p><strong><code>Object.defineProperty</code></strong> 允许精确添加或修改对象的属性。通过赋值操作添加的普通属性是可枚举的，能够在属性枚举期间呈现出来。</p> <p>描述符可同时具有的键值：</p> <table><thead><tr><th></th> <th>configurable</th> <th>enumerable</th> <th>value</th> <th>writable</th> <th>get</th> <th>set</th></tr></thead> <tbody><tr><td>数据描述符</td> <td>Yes</td> <td>Yes</td> <td>Yes</td> <td>Yes</td> <td>No</td> <td>No</td></tr> <tr><td>存取描述符</td> <td>Yes</td> <td>Yes</td> <td>No</td> <td>No</td> <td>Yes</td> <td>Yes</td></tr></tbody></table> <p>所以我们有以下这种效果：</p> <p><img src="https://fish-pond-1253945200.cos.ap-guangzhou.myqcloud.com/js/godot/gd1.gif" alt="gd1"></p> <p>代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">'use strict'</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>godot<span class="token punctuation">,</span> <span class="token string">'style'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">const</span> distance <span class="token operator">=</span> <span class="token punctuation">(</span>noLeftTree<span class="token punctuation">.</span>offsetLeft <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offsetLeft<span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>distance <span class="token operator">&gt;=</span> <span class="token number">51</span> <span class="token operator">?</span> <span class="token string">'戈多没来，我们先各自干各自的活吧'</span> <span class="token punctuation">:</span> <span class="token string">'戈多快到了，走，我们集合去'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">whereIsGodot</span> <span class="token operator">=</span> start <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> d <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">const</span> <span class="token function-variable function">godotRun</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>noLeftTree<span class="token punctuation">.</span>offsetLeft <span class="token operator">-</span> <span class="token number">51</span> <span class="token operator">&gt;=</span> d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    d<span class="token operator">++</span>
                    godot<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token template-string"><span class="token string">`left: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>d<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px`</span></span>
                    <span class="token function">godotRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">godotRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>简单来说就是使用 <strong><code>Object.defineProperty</code></strong> 监听戈多的位置变化，然后当戈多移动到集合地点附近时，等待戈多的俩哥们就可以去赴约了。通过上述的代码，我们可以知道 <code>whereIsGodot</code> 函数只负责戈多的位置移动，但是监听权在等待戈多的两个人那里，这样保证了代码语义化的同时，耦合度也尽可能地小。</p> <h2 id="mutationobserver"><a href="#mutationobserver" aria-hidden="true" class="header-anchor">#</a> MutationObserver</h2> <p>Mmmmm，我一直以为 <strong><code>MutationObserver</code></strong> 是个新属性，直到我<s>膝盖中了一箭</s>看了<a href="https://caniuse.com/#search=MutationObserver" target="_blank" rel="noopener noreferrer">can i use<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 。</p> <p><img src="https://fish-pond-1253945200.cos.ap-guangzhou.myqcloud.com/js/godot/caniuse1.png" alt="caniuse"></p> <p>本来鱼头我也不知道有这属性，但是最近在工作上遇到了需要监听页面元素变动的场景，然后就了解到了这个API。</p> <p>于是鱼头便看了<a href="https://dom.spec.whatwg.org/#mutation-observers" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，发现是个好牛逼的API。</p> <p><img src="https://fish-pond-1253945200.cos.ap-guangzhou.myqcloud.com/js/godot/dc.jpg" alt="dc"></p> <h4 id="所以这到底是个啥？"><a href="#所以这到底是个啥？" aria-hidden="true" class="header-anchor">#</a> 所以这到底是个啥？</h4> <p>简单来说就是一个可以监听 <strong>DOM Tree</strong> 变动的API，名字直译就是 <strong>“突变观察者”</strong> 。</p> <p>按<a href="https://dom.spec.whatwg.org/#mutation-observers" target="_blank" rel="noopener noreferrer">WHATWG<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的定义，它的执行逻辑如下：</p> <ol><li>先执行监听的微任务队列；</li> <li>执行完微任务队列之后就把所监听的记录封装成一个数组来处理；</li> <li>然后返回处理结果。</li></ol> <h4 id="所以具体怎么用？"><a href="#所以具体怎么用？" aria-hidden="true" class="header-anchor">#</a> 所以具体怎么用？</h4> <p><strong>突变观察者</strong> 是个构造器，它接受一个回调并返回一个 <strong>节点记录列表（sequence <code>&lt;MutationRecord&gt;</code> ）</strong> 以及 <strong>构造的参数对象（MutationObersver）</strong>。</p> <p>它有以下三个方法：</p> <ol><li>observe(target, options)：监听对象，接受两个参数，一个是监听的对象（target），一个是观察的选项(options)；</li> <li>disconnect()：断开监听的功能；</li> <li>takeRecords()：清空监听的队列，并返回结果。</li></ol> <p>options选项可选参数（以下属性可设置为true）：</p> <ol><li>childList：监听目标子节点的变化；</li> <li>attributes：监听目标属性的变化；</li> <li>characterData：监听目标数据的变化；</li> <li>subtree：监听目标以及其后代的变化；</li> <li>attributeOldValue：监听目标属性变化前的具体值；</li> <li>characterDataOldValue：监听目标数据变化前的具体值；</li> <li>attributeFilter：不需要监听的属性列表（此属性填入过滤的属性列表）。</li></ol> <h4 id="如何监听戈多的位置？"><a href="#如何监听戈多的位置？" aria-hidden="true" class="header-anchor">#</a> 如何监听戈多的位置？</h4> <p>下面我们就通过实际的代码来监听戈多的位置变化。</p> <p>效果还是如同上图。</p> <p>代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> godot <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#godot'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
    childList<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    attributes<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    characterData<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    subtree<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    attributeOldValue<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    characterDataOldValue<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">mutationCallback</span> <span class="token operator">=</span> mutationsList <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            target<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                offsetLeft<span class="token punctuation">:</span> godotPos
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span> <span class="token operator">=</span> mutationsList
    <span class="token keyword">const</span> distance <span class="token operator">=</span> <span class="token punctuation">(</span>noLeftTree<span class="token punctuation">.</span>offsetLeft <span class="token operator">-</span> godotPos<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>distance <span class="token operator">&gt;=</span> <span class="token number">51</span> <span class="token operator">?</span> <span class="token string">'戈多没来，我们先各自干各自的活吧'</span> <span class="token punctuation">:</span> <span class="token string">'戈多快到了，走，我们集合去'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>mutationCallback<span class="token punctuation">)</span>
observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>godot<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">whereIsGodot</span> <span class="token operator">=</span> start <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> d <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">const</span> <span class="token function-variable function">godotRun</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>noLeftTree<span class="token punctuation">.</span>offsetLeft <span class="token operator">-</span> <span class="token number">51</span> <span class="token operator">&gt;=</span> d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    d<span class="token operator">++</span>
                    godot<span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token template-string"><span class="token string">`left: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>d<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px`</span></span>
                    <span class="token function">godotRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                observer<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">godotRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因为鱼头在业务需要对某个已经完善的功能在部分操作监听数据变动，如果对原来的代码进行改动，也不是一件轻松的事，而且这样子代码太冗长，耦合度也会较高，所以就选择了用 <strong>突变观察者</strong> 来实现，效果还是不错的。</p> <h2 id="intersection-observer"><a href="#intersection-observer" aria-hidden="true" class="header-anchor">#</a> Intersection Observer</h2> <p>除了监听元素的变动，还有什么方式可以知道戈多的位置呢？</p> <p>如果有那就是 <strong>Intersection Observer</strong> 了。</p> <h4 id="这又是个啥？"><a href="#这又是个啥？" aria-hidden="true" class="header-anchor">#</a> 这又是个啥？</h4> <p>戈多心想：“又来一个Observer ？别监听了，我去找你们就是了，嘤嘤嘤。 ”</p> <p><img src="https://fish-pond-1253945200.cos.ap-guangzhou.myqcloud.com/js/godot/weiqu2.jpg" alt="委屈"></p> <p><strong><code>IntersectionObserver</code></strong> 直译是 <strong>“交叉观察者”</strong> ，这个API使开发人员能够监听目标元素与根（祖先或视口）元素交叉状态的方法。</p> <p>它的用法跟 <strong><code>MutationObserver</code></strong> 相似，同样是个构造器，它接受一个 <strong>回调函数(callback(entries))</strong> 以及 <strong>可选参数对象（options）</strong> 。</p> <h4 id="所以又怎么用？"><a href="#所以又怎么用？" aria-hidden="true" class="header-anchor">#</a> 所以又怎么用？</h4> <p>首先 <strong>callback</strong> 会返回一个 <strong>监听属性对象（IntersectionObserverEntry）</strong> ，其具体属性如下：</p> <ol><li>time：可见性发生变化的时间，是个双精度的毫秒时间戳；</li> <li>rootBounds：根元素的盒子区域信息，有根元素则返回 <code>getBoundingClientRect()</code> 的值，没有则返回 <code>null</code>；</li> <li>boundingClientRect：监听元素的盒子区域信息；</li> <li>intersectionRect：监听元素与根元素的交叉区域信息；</li> <li>isIntersecting：判断监听元素是否与根元素相交，返回布尔值；</li> <li>intersectionRatio：监听元素的可见比例，即<code>intersectionRect / boundingClientRect</code> 完全可见时为1，完全不可见时小于等于0；</li> <li>target：监听的目标元素。</li></ol> <p><strong>options</strong> 可选参数如下：</p> <ol><li>root：与监听对象相交的根元素，如果没有，返回隐式根；</li> <li>rootMargin：跟CSS的<code>margin</code>一样，发生交叉的偏移量；</li> <li>threshold：触发回调的阈值，填入数组，范围在0~1之间，决定发生监听事件的交叉比例。</li></ol> <p>可选择方法如下：</p> <ol><li>IntersectionObserver.observe()：开始监听；</li> <li>IntersectionObserver.disconnect()：停止监听；</li> <li>IntersectionObserver.takeRecords()：返回所有观察目标的 <strong>IntersectionObserverEntry</strong> 对象数组；</li> <li>IntersectionObserver.unobserve()：使<code>IntersectionObserver</code>停止监听特定目标元素。</li></ol> <h4 id="戈多，你今晚到底是来还是不来？"><a href="#戈多，你今晚到底是来还是不来？" aria-hidden="true" class="header-anchor">#</a> 戈多，你今晚到底是来还是不来？</h4> <p>所以怎么用这个API来监听戈多的位置呢？</p> <p>先看效果（真特么简陋）</p> <p><img src="https://fish-pond-1253945200.cos.ap-guangzhou.myqcloud.com/js/godot/godot3.gif" alt="godot3"></p> <p>代码如下：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style language-css">
    <span class="token selector">*</span> <span class="token punctuation">{</span>
        <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
        <span class="token property">padding</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
        <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">html,
    body</span> <span class="token punctuation">{</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 200%<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">noLeftTree</span> <span class="token punctuation">{</span>
        <span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span>
        <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
        <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
        <span class="token property">background</span><span class="token punctuation">:</span> #FFF<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">godot,
    estragon,
    vladimir</span> <span class="token punctuation">{</span>
        <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
        <span class="token property">border-radius</span><span class="token punctuation">:</span> 50%<span class="token punctuation">;</span>
        <span class="token property">border</span><span class="token punctuation">:</span> 1px solid<span class="token punctuation">;</span>
        <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">estragon</span> <span class="token punctuation">{</span>
        <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
        <span class="token property">left</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">vladimir</span> <span class="token punctuation">{</span>
        <span class="token property">top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
        <span class="token property">right</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">godot</span> <span class="token punctuation">{</span>
        <span class="token property">left</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>50% - 25px<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token property">top</span><span class="token punctuation">:</span> 1000px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>noLeftTree</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>noLeftTree<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>estragon</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>estragon<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>戈戈<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>estragon</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>vladimir</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>vladimir<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>狄狄<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>vladimir</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>noLeftTree</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>godot</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>godot<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>戈多<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>godot</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
    <span class="token string">'use strict'</span>
    <span class="token keyword">const</span> godot <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#godot'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> noLeftTree <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#noLeftTree'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">ioCallback</span> <span class="token operator">=</span> entries <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>intersectionRatio <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">'戈多没来，我们先各自干各自的活吧'</span> <span class="token punctuation">:</span> <span class="token string">'戈多快到了，走，我们集合去'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> ioConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
        threshold<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.75</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>ioCallback<span class="token punctuation">,</span> ioConfig<span class="token punctuation">)</span>
    io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>godot<span class="token punctuation">)</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="后记"><a href="#后记" aria-hidden="true" class="header-anchor">#</a> 后记</h2> <p>其实如果肯花时间去研究，利用好上述三个API，是可以实现很多很有趣的效果的，上面的只是一个初尝的DEMO，真正在项目里是可以实现很多很重要的功能。</p> <p>不过戈戈 与 狄狄也等待戈多快70年了，就像痴情的女生等待远走的渣男一样，就是不来好歹也给个音信啊。</p> <p>戈多心想：“我不过是迷路了么，嘤嘤嘤”</p> <p><img src="https://fish-pond-1253945200.cos.ap-guangzhou.myqcloud.com/js/godot/yingyingying.jpg" alt="img"></p> <p>如果你喜欢探讨技术，或者对本文有任何的意见或建议，非常欢迎加鱼头微信好友一起探讨，当然，鱼头也非常希望能跟你一起聊生活，聊爱好，谈天说地。
鱼头的微信号是：krisChans95
也可以扫码关注公众号，订阅更多精彩内容。
<img src="https://fish-pond-1253945200.cos.ap-guangzhou.myqcloud.com/img/base/qrcode-all1.png" alt="https://fish-pond-1253945200.cos.ap-guangzhou.myqcloud.com/img/base/qrcode-all1.png"></p></div> <div class="page-footer content">
    网站备案号：粤ICP备17113436号-1
  </div> <!----> <div class="right-group"><div class="item"><span class="title">加入前端鱼塘</span> <span class="desc">
        扫描二维码回复
        <span class="inner">加群</span> 学习
      </span> <img width="100%" src="https://fish-pond-1253945200.cos.ap-guangzhou.myqcloud.com/img/base/wx-qrcode.jpg"></div></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <div></div></div></div>
    <script src="/assets/js/37.6b8a54ca.js" defer></script><script src="/assets/js/app.64027d33.js" defer></script>
    <!-- Hotjar Tracking Code for yuchengkai.cn -->
    <script>
      var _hmt = _hmt || []
      ;(function() {
        var hm = document.createElement('script')
        hm.src = 'https://hm.baidu.com/hm.js?52ee35894430604d0d3ce3b9c089adf9'
        var s = document.getElementsByTagName('script')[0]
        s.parentNode.insertBefore(hm, s)
      })()
    </script>
  </body>
</html>
